<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Doanh số bán theo tháng</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { text-align: center; color: teal; }
    .bar-label {
      fill: white;
      font-size: 12px;
      font-weight: bold;
      text-anchor: middle;
    }
    .axis-label {
      font-size: 12px;
      fill: #333;
    }
  </style>
</head>
<body>
  <h2>Doanh số bán theo tháng</h2>
  <div id="chart"></div>

<script>
d3.csv("data_ggsheet.csv").then(rows => {
  rows.forEach(d => {
    d.ThanhTien = +String(d["Thành tiền"]).replace(/[^\d.-]/g,"");
    d.Date = new Date(d["Thời gian tạo đơn"]);
    d.Month = d.Date.getMonth() + 1;  // 1–12
    d.Year = d.Date.getFullYear();
  });

  // Lấy năm mới nhất
  const currentYear = d3.max(rows, d=>d.Year);

  // Gom doanh số theo tháng
  const byMonth = d3.rollups(
    rows.filter(d=>d.Year===currentYear),
    v => d3.sum(v, d => d.ThanhTien),
    d => d.Month
  );

  let data = byMonth.map(([Month, Sales]) => ({ 
    Month, 
    Sales 
  }));

  // Đảm bảo đủ 12 tháng
  for (let m=1;m<=12;m++){
    if (!data.find(d=>d.Month===m)){
      data.push({Month:m, Sales:0});
    }
  }
  data.sort((a,b)=> a.Month - b.Month);

  const maxSales = d3.max(data, d=>d.Sales);
  const color = d3.scaleSequential(d3.interpolateBlues)
                  .domain([0,maxSales]);

  // Thiết lập kích thước
  const margin = {top:30, right:30, bottom:50, left:80};
  const width = 900 - margin.left - margin.right;
  const height = 500 - margin.top - margin.bottom;

  const svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform",`translate(${margin.left},${margin.top})`);

  const x = d3.scaleBand()
    .domain(data.map(d=>"Tháng "+d.Month))
    .range([0,width])
    .padding(0.2);

  const y = d3.scaleLinear()
    .domain([0, maxSales])
    .nice()
    .range([height,0]);

  // Vẽ cột
  svg.selectAll(".bar")
    .data(data)
    .enter()
    .append("rect")
    .attr("x", d=>x("Tháng "+d.Month))
    .attr("y", d=>y(d.Sales))
    .attr("width", x.bandwidth())
    .attr("height", d=>height - y(d.Sales))
    .attr("fill", d=>color(d.Sales))
    .attr("rx",4);

  // Nhãn trên cột
  svg.selectAll(".bar-label")
    .data(data)
    .enter()
    .append("text")
    .attr("class","bar-label")
    .attr("x", d=>x("Tháng "+d.Month) + x.bandwidth()/2)
    .attr("y", d=>y(d.Sales)-5)
    .text(d=> d.Sales>0 ? (d.Sales/1000000).toFixed(0)+"M" : "");

  // Trục X
  svg.append("g")
    .attr("transform",`translate(0,${height})`)
    .call(d3.axisBottom(x));

  // Trục Y
  svg.append("g")
    .call(d3.axisLeft(y).ticks(8).tickFormat(d=>d/1000000+"M"));
});
</script>
</body>
</html>
